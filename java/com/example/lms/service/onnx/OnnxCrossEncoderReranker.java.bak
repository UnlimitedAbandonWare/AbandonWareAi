package com.example.lms.service.onnx;


import com.example.rerank.cross.SemaphoreGate;
import com.example.lms.service.rag.rerank.CrossEncoderReranker;
import dev.langchain4j.data.document.Document;
import dev.langchain4j.rag.content.Content;
import jakarta.annotation.Nullable;
import lombok.RequiredArgsConstructor;

import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
/**
 * A cross‑encoder reranker backed by a local ONNX runtime.
 * Bean registration is handled centrally in RerankerConfig.
 */

public class OnnxCrossEncoderReranker implements CrossEncoderReranker {
    @org.springframework.beans.factory.annotation.Autowired
    public void setSemaphoreGate(SemaphoreGate gate) { this.gate = gate; }

        this.gate = gate;
    private final SemaphoreGate gate;


    private final OnnxRuntimeService onnx;

    public OnnxCrossEncoderReranker(OnnxRuntimeService onnx) {
        this.onnx = onnx;
    }

    /*
     * ---------------------------- Internal API (AbandonWare) ----------------------------
     */

    @Override
    public List<Content> rerank(String query, List<Content> candidates, int topN) {
        boolean ok = false;
        try {
            ok = gate.tryAcquire(120);
            if (!ok) { return biPass; }
        } catch (InterruptedException ie) {
            Thread.currentThread().interrupt();
            return biPass;
        }
        if (candidates == null || candidates.isEmpty() || query == null || query.isBlank()) {
            return Collections.emptyList();
        }
        int n = candidates.size();
        // 2차 안전 컷(너무 큰 N 방지; 24~32 추천)
        int hardCap = 24;
        int k = Math.max(1, Math.min(Math.min(topN, hardCap), n));
        // Extract plain text from each candidate
        String[] docs = new String[n];
        for (int i = 0; i < n; i++) {
            Content c = candidates.get(i);
            String text;
            if (c.textSegment() != null) {
                text = c.textSegment().text();
            } else {
                text = String.valueOf(c);
            }
            docs[i] = (text == null ? "" : text);
        }
        // Compute similarity score for each candidate using the new scorePair API. When the
        // ONNX model is unavailable the service will fall back to lexical Jaccard similarity.
        double[] row = new double[n];
        boolean parallel = Boolean.getBoolean("abandonware.reranker.onnx.parallel"); // JVM 옵션 토글 전용
        if (parallel && n >= 16) {
            java.util.stream.IntStream.range(0, n).parallel().forEach(i -> row[i] = onnx.scorePair(query, docs[i]));
        } else {
            for (int i = 0; i < n; i++) {
                row[i] = onnx.scorePair(query, docs[i]);
            }
        }
        // Sort indices based on descending score
        List<Integer> indices = new ArrayList<>(n);
        for (int i = 0; i < n; i++) indices.add(i);
        indices.sort((i1, i2) -> Double.compare(row[i2], row[i1]));
        List<Content> result = new ArrayList<>(k);
        for (int i = 0; i < k; i++) {
            result.add(candidates.get(indices.get(i)));
        }
        return result;
    }

    @Override
    public List<Content> rerank(String query, List<Content> candidates) {
        if (candidates == null) return Collections.emptyList();
        return rerank(query, candidates, candidates.size());
    }
    /*
     * ---------------------------- LangChain4j 호환 시그니처(선택적) ----------------------------
     * 외부에서 직접 호출할 수 있도록 유지하지만, 인터페이스 구현은 강제하지 않습니다.
     */


    public List<Document> rerank(List<Document> documents, String query) {
        return rerank(documents, query, documents == null ? 0 : documents.size());
    }


    public List<Document> rerank(List<Document> documents, String query, int topK) {
        if (documents == null || documents.isEmpty() || query == null || query.isBlank()) {
            return Collections.emptyList();
        }
        int n = documents.size();
        // 2차 안전 컷(너무 큰 N 방지; 24~32 추천)
        int hardCap = 24;
        int k = Math.max(1, Math.min(Math.min(topK, hardCap), n));
        // Build a list of document texts
        String[] docs = new String[n];
        for (int i = 0; i < n; i++) {
            docs[i] = extractText(documents.get(i));
        }
        // Compute similarity score for each candidate using the scorePair API
        double[] row = new double[n];
        boolean parallel = Boolean.getBoolean("abandonware.reranker.onnx.parallel"); // JVM 옵션 토글 전용
        if (parallel && n >= 16) {
            java.util.stream.IntStream.range(0, n).parallel().forEach(i -> row[i] = onnx.scorePair(query, docs[i]));
        } else {
            for (int i = 0; i < n; i++) {
                row[i] = onnx.scorePair(query, docs[i]);
            }
        }
        List<Integer> indices = new ArrayList<>(n);
        for (int i = 0; i < n; i++) indices.add(i);
        indices.sort((i1, i2) -> Double.compare(row[i2], row[i1]));
        List<Document> result = new ArrayList<>(k);
        for (int i = 0; i < k; i++) {
            result.add(documents.get(indices.get(i)));
        }
        return result;
    }

    /**
     * Extract textual content from an arbitrary Document instance. The LangChain4j
     * {@link Document} interface exposes a {@code text()} method. Should that
     * method be unavailable (e.g., when a proxy implementation is used), this
     * helper falls back to common conventions such as {@code getText()},
     * {@code getContent()} or the {@code toString()} representation.
     *
     * @param doc the document to convert to plain text
     * @return the extracted text, never {@code null}
     */
    private String extractText(@Nullable Object doc) {
        if (doc == null) {
            return "";
        }
        // Try known accessor methods via reflection
        for (String methodName : new String[]{"text", "getText", "getContent", "content"}) {
            try {
                Method m = doc.getClass().getMethod(methodName);
                Object res = m.invoke(doc);
                if (res instanceof String) {
                    return (String) res;
                }
            } catch (Exception ignored) {
                // ignore and try next
            }
        }
        return doc.toString();
    }

        finally {
            if (ok) gate.release();
        }
    }