# MERGE_HOOK:PROJ_AGENT::FIM15
llm:
  provider: local
  model: ${llm.high.model:${llm.chat-model}}

id: sidetrain_v1
description: "보조 검증 및 재탐색 플랜"
steps:
  - name: analyze_intent
    tool: qa.selfask
  - name: retrieve_hybrid
    tool: qa.retrieve
    params: { sources: [web, vector], web_top_k: 10, vector_top_k: 5 }
  - name: fuse_results
    tool: rank.fusion
    params: { method: weighted_rrf, weights: {web: 0.6, vector: 0.4} }
  - name: rerank_bi
    tool: rank.bi_encoder
  - name: rerank_cross
    tool: rank.cross_encoder
    params: { max_concurrency: 2, device: 1 }
  - name: verify_consistency
    tool: qa.probe
    params: { useWeb: true, useRag: false, intent: "verify" }
  - name: compare_and_refine
    tool: logic.diff
    params: { on_mismatch: "redo_retrieve" }
  - name: conditional_search
    tool: qa.retrieve
    when: "mismatch == true"
    params: { sources: [web], web_top_k: 5, query: "$diff_insight" }
  - name: apply_gates
    tool: gate.aggregate
    params:
      - DomainWhitelist
      - CitationGate: { min: 3 }
      - FinalSigmoidGate: { threshold: 0.85 }
      - AnswerSanitizer
  - name: generate_answer
    tool: qa.compose
    params: { mode: "validated" }